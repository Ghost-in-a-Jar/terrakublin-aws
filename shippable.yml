language: java

jdk: openjdk8

# use this to control what branches get built.
# http://docs.shippable.com/ci/advancedOptions/branches/
branches:
  only:
    - develop
    - master

build:
  ci:
    - jq -r "to_entries|map(\"\(.key)=\(.value|tostring)\")|.[]" terraform/infra/terraform.out
    - if [ "$BRANCH" == "master" ]; then export ENV=production; fi
    - if [ "$BRANCH" == "develop" ]; then export ENV=develop; fi
    - TAG=`git tag -l --points-at HEAD`
    - IMG=$NAME:$TAG
    - LATEST=$NAME:latest
    - docker build -t $IMG .
    - docker tag $IMG$LATEST

  post_ci:
    - docker push $NAME
    - docker tag $LATEST $NAME

# Integrations are used to connect external resources to CI
# http://docs.shippable.com/integrations/overview/
integrations:
  hub:
    - integrationName: shippable_terrakublin_aws
      region: us-east-1
      type: ecr
