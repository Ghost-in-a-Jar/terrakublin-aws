language: java

jdk: openjdk8

# use this to control what branches get built.
# http://docs.shippable.com/ci/advancedOptions/branches/
branches:
  only:
    - develop
    - master

infra:
  pre_prov:
    - pushd terraform/infra
    - terraform plan
    - popd

  prov:
    - pushd terraform/infra
    - terraform apply -state=/shippableci/shippable/provision/terraform.tfstate
    - popd

  post_prov:
    - pushd terraform/infra
    - yes yes 2>/dev/null | terraform destroy -state=/shippableci/shippable/provision/terraform.tfstate
    - popd

build:
  ci:
    - sdk use gradle 5.2.1
    - if [ "$BRANCH" == "master" ]; then export ENV=production; fi
    - if [ "$BRANCH" == "develop" ]; then export ENV=develop; fi
    - gradle wrapper --gradle-version 5.2.1
    - ./gradlew assemble
    - ./gradlew dockerClean
    - ./gradlew dockerPrepare
    - ./gradlew docker
    - ./gradlew dockerTag latest
    - ./gradlew dockerTestRunner

  post_ci:
    - ./gradlew dockerPushLatest

# Integrations are used to connect external resources to CI
# http://docs.shippable.com/integrations/overview/
integrations:
  hub:
    - integrationName: shippable_terrakublin_aws
      region: us-east-1
      type: ecr
