language: java

jdk:
  - openjdk8

# use this to control what branches get built.
# http://docs.shippable.com/ci/advancedOptions/branches/
branches:
  only:
    - develop
    - master

build:
  pre_ci:
    - if [ "$BRANCH" == "master" ]; then export ENV=production; fi
    - if [ "$BRANCH" == "develop" ]; then export ENV=develop; fi
    - pushd terraform
    - ./build_and_deploy.sh
    - popd
    - gradle assemble
    - gradle dockerClean
    - gradle dockerPrepare
    - gradle docker
    - gradle dockerTag latest

  pre_ci_boot:
    image_name: $IMAGE_NAME   ##replace with your repo and image name
    image_tag: latest
    pull: false

  ci:
    - gradle dockerTestRunner

  post_ci:
    - gradle dockerPushLatest
    - pushd terraform
    - ./build_and_deploy.sh
    - popd

# Integrations are used to connect external resources to CI
# http://docs.shippable.com/integrations/overview/
integrations:
  hub:
    - integrationName: shippable_terrakublin_aws
      region: us-east-1
      type: ecr
